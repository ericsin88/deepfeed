<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>AIæç¤ºè©ç”Ÿæˆå™¨</title>
  <link rel="icon" href="data:,">
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --accent-color: #9b59b6;
      --success-color: #2ecc71;
      --warning-color: #f39c12;
      --danger-color: #e74c3c;
      --light-bg: #f8f9fa;
      --dark-text: #333;
      --light-text: #fff;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 100px 20px 20px;
      background-color: #f5f7fa;
      color: var(--dark-text);
      line-height: 1.6;
    }
    
    .hidden { display: none; }
    
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, var(--primary-color), #1a2530);
      padding: 10px 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 100;
    }
    
    .logo-container {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .logo {
      height: 45px;
      filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2));
    }
    
    .app-title {
      color: white;
      font-size: 1.5rem;
      font-weight: 600;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .theme-nav {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 70px 0 25px;
      padding: 15px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.08);
    }
    
    .theme-nav-item {
      padding: 10px 16px;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s ease;
      background: #f0f4f8;
      font-weight: 500;
      border: 2px solid transparent;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .theme-nav-item:hover {
      background: #e3eaf3;
      transform: translateY(-2px);
    }
    
    .theme-nav-item.active {
      background: var(--secondary-color);
      color: white;
      border-color: #2980b9;
      box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
    }
    
    .step {
      margin: 25px 0;
      padding: 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      border-left: 4px solid var(--secondary-color);
      transition: all 0.3s ease;
    }
    
    .step h3 {
      margin-bottom: 15px;
      color: var(--primary-color);
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .step h3:before {
      content: "â€¢";
      color: var(--secondary-color);
      font-size: 1.8rem;
    }
    
    .option {
      margin: 8px;
      padding: 12px 18px;
      display: inline-block;
      border: 2px solid #e0e6ed;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.25s ease;
      font-weight: 500;
      background: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .option:hover {
      border-color: var(--secondary-color);
      background: #f0f7ff;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(52, 152, 219, 0.15);
    }
    
    .option.selected {
      background: var(--secondary-color);
      color: white;
      border-color: #2980b9;
      box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3);
    }
    
    #adminPanel {
      background: white;
      padding: 25px;
      margin-top: 30px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.1);
    }
    
    .theme-block {
      margin: 20px 0;
      padding: 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      border: 1px solid #eaeff5;
    }
    
    .login-panel {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 30px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      z-index: 1000;
      width: 90%;
      max-width: 450px;
    }
    
    .text-input-mode input {
      width: 100%;
      padding: 12px 15px;
      margin-top: 10px;
      border: 2px solid #e0e6ed;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }
    
    .text-input-mode input:focus {
      border-color: var(--secondary-color);
      outline: none;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }
    
    #adminEntry {
      background: white;
      color: var(--primary-color);
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    #adminEntry:hover {
      background: #f0f4f8;
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    
    .button-group {
      margin-top: 25px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .title {
      position: absolute;
      top: 75px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.8rem;
      color: var(--primary-color);
      font-weight: 700;
      text-align: center;
      width: 100%;
      text-shadow: 0 2px 3px rgba(0,0,0,0.1);
    }
    
    #result {
      margin-top: 30px;
      padding: 25px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      white-space: pre-wrap;
      border-top: 4px solid var(--success-color);
    }
    
    #result pre {
      font-family: 'Consolas', 'Courier New', monospace;
      line-height: 1.5;
      padding: 15px;
      background: #f8fafc;
      border-radius: 8px;
      overflow-x: auto;
      border-left: 3px solid var(--secondary-color);
    }
    
    .result-actions {
      margin-top: 20px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .sortable-ghost { 
      opacity: 0.5; 
      background: #f0f7ff; 
    }
    
    .custom-input {
      margin-top: 20px;
    }
    
    .custom-input input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e6ed;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }
    
    .custom-input input:focus {
      border-color: var(--secondary-color);
      outline: none;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }
    
    .multi-select-options {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .multi-select-options .option {
      margin: 0;
    }
    
    .selected-options {
      margin-top: 20px;
      padding: 15px;
      background: #f0f7ff;
      border-radius: 8px;
      border: 1px dashed var(--secondary-color);
    }
    
    .selected-options h4 {
      margin-bottom: 10px;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .selected-options h4:before {
      content: "âœ“";
      color: var(--success-color);
    }
    
    .selected-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .tag {
      padding: 6px 12px;
      background: var(--secondary-color);
      color: white;
      border-radius: 20px;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .tag-remove {
      cursor: pointer;
      font-weight: bold;
      font-size: 1.1rem;
      padding: 0 3px;
    }
    
    button {
      padding: 12px 24px;
      background: var(--secondary-color);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    button:hover {
      background: #2980b9;
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(52, 152, 219, 0.4);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    button#prevBtn, button#backToFrontBtn {
      background: #7f8c8d;
    }
    
    button#prevBtn:hover, button#backToFrontBtn:hover {
      background: #6c7a7d;
    }
    
    button#generateBtn {
      background: var(--success-color);
    }
    
    button#generateBtn:hover {
      background: #27ae60;
    }
    
    button#loginBtn {
      background: var(--success-color);
    }
    
    button#saveThemeBtn {
      background: var(--accent-color);
    }
    
    button#changePasswordBtn {
      background: #16a085;
    }
    
    button.delete-btn {
      background: var(--danger-color);
    }
    
    input, textarea, select {
      padding: 12px 15px;
      border: 2px solid #e0e6ed;
      border-radius: 8px;
      font-size: 1rem;
      width: 100%;
      margin-bottom: 15px;
      transition: border-color 0.3s;
    }
    
    input:focus, textarea:focus, select:focus {
      border-color: var(--secondary-color);
      outline: none;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }
    
    textarea {
      min-height: 120px;
      resize: vertical;
    }
    
    .option-settings {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin: 20px 0;
    }
    
    .option-settings label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 10px;
      background: #f8fafc;
      border-radius: 8px;
      transition: background 0.3s;
    }
    
    .option-settings label:hover {
      background: #edf2f7;
    }
    
    .progress-container {
      height: 8px;
      background: #edf2f7;
      border-radius: 4px;
      margin: 25px 0 15px;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 100%;
      background: var(--secondary-color);
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    
    .theme-count {
      text-align: center;
      color: #7f8c8d;
      font-size: 0.9rem;
      margin-bottom: 5px;
    }
    
    .admin-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 20px;
    }
    
    .admin-controls button {
      flex: 1;
      min-width: 150px;
    }
    
    .password-field {
      position: relative;
    }
    
    .password-toggle {
      position: absolute;
      right: 15px;
      top: 14px;
      cursor: pointer;
      color: #7f8c8d;
    }
    
    h2, h3, h4 {
      color: var(--primary-color);
      margin-bottom: 15px;
    }
    
    h2 {
      font-size: 1.8rem;
      text-align: center;
      margin-bottom: 25px;
    }
    
    .login-panel h2 {
      color: var(--primary-color);
    }
    
    .theme-block h3 {
      font-size: 1.4rem;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f4f8;
    }
    
    .notification {
      padding: 15px;
      margin: 15px 0;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .notification.success {
      background: var(--success-color);
    }
    
    .notification.error {
      background: var(--danger-color);
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body>
  <div class="header">
    <div class="logo-container">
      <img src="https://ericsin88.github.io/deepfeed/deepfeed_logo.png" class="logo" alt="AIæç¤ºè¯ç”Ÿæˆå™¨">
      <div class="app-title">AIæç¤ºè¯ç”Ÿæˆå™¨</div>
    </div>
    <button id="adminEntry">é€²å…¥å¾Œå°ç®¡ç†</button>
  </div>
  <h1 class="title">AIåœ–ç‰‡/å‹•ç•«æç¤ºè©ç”Ÿæˆå™¨</h1>

  <!-- å‰å°ç•Œé¢ -->
  <div id="frontend">
    <div class="theme-count">ä¸»é¡Œ: <span id="currentStep">1</span>/<span id="totalSteps">0</span></div>
    <div class="progress-container">
      <div class="progress-bar" id="progressBar" style="width: 0%"></div>
    </div>
    <div class="theme-nav" id="themeNav"></div>
    <div id="steps"></div>
    <div class="button-group">
      <button id="prevBtn">â† ä¸Šä¸€æ­¥</button>
      <button id="nextBtn">ä¸‹ä¸€æ­¥ â†’</button>
      <button id="generateBtn">ç”Ÿæˆæç¤ºè©</button>
    </div>
    <div id="result"></div>
  </div>

  <!-- ç™»å…¥é¢æ¿ -->
  <div id="loginPanel" class="hidden login-panel">
    <h2>å¾Œå°ç®¡ç†ç™»å…¥</h2>
    <div class="password-field">
      <input type="password" id="password" placeholder="è¼¸å…¥ç®¡ç†å¯†ç¢¼">
      <span class="password-toggle" id="passwordToggle">ğŸ‘ï¸</span>
    </div>
    <div id="loginMessage" class="notification hidden"></div>
    <div class="button-group">
      <button id="loginBtn">ç™»å…¥</button>
      <button id="cancelBtn">å–æ¶ˆ</button>
    </div>
  </div>

  <!-- å¾Œå°ç®¡ç† -->
  <div id="adminPanel" class="hidden">
    <button id="backToFrontBtn">â† è¿”å›å‰å°</button>
    
    <div class="theme-block">
      <h3>ä¿®æ”¹ç®¡ç†å¯†ç¢¼</h3>
      <div class="password-field">
        <input type="password" id="oldPassword" placeholder="èˆŠå¯†ç¢¼">
        <span class="password-toggle" id="oldPasswordToggle">ğŸ‘ï¸</span>
      </div>
      <div class="password-field">
        <input type="password" id="newPassword" placeholder="æ–°å¯†ç¢¼">
        <span class="password-toggle" id="newPasswordToggle">ğŸ‘ï¸</span>
      </div>
      <div class="password-field">
        <input type="password" id="confirmPassword" placeholder="ç¢ºèªæ–°å¯†ç¢¼">
        <span class="password-toggle" id="confirmPasswordToggle">ğŸ‘ï¸</span>
      </div>
      <div id="passwordMessage" class="notification hidden"></div>
      <button id="changePasswordBtn">ä¿®æ”¹å¯†ç¢¼</button>
    </div>

    <div class="theme-block">
      <h3>æ–°å¢/ç·¨è¼¯ä¸»é¡Œ</h3>
      <input type="text" id="newThemeName" placeholder="ä¸»é¡Œåç¨±">
      <textarea id="newThemeOptions" placeholder="è¼¸å…¥é¸é …ï¼ˆæ¯è¡Œä¸€å€‹ï¼‰" rows="5"></textarea>
      <div class="option-settings">
        <label><input type="checkbox" id="allowCustom"> å…è¨±è‡ªå®šç¾©è¼¸å…¥</label>
        <label><input type="checkbox" id="isTextInput"> ç´”æ–‡å­—è¼¸å…¥æ¨¡å¼</label>
        <label><input type="checkbox" id="allowMultiSelect"> å®¹è¨±ä¸»é¡Œä½œå¤šé …é¸æ“‡</label>
      </div>
      <div id="themeMessage" class="notification hidden"></div>
      <button id="saveThemeBtn">ä¿å­˜ä¸»é¡Œ</button>
    </div>

    <div id="existingThemes">
      <h3>ç¾æœ‰ä¸»é¡Œç®¡ç†ï¼ˆæ‹–å‹•æ’åºï¼‰</h3>
      <div id="themeList"></div>
    </div>
  </div>

<script>
(function() {
  // Supabaseé…ç½®
  const SUPABASE_URL = 'https://wenvirapddldhhfnhtxv.supabase.co';
  const SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlbnZpcmFwZGRsZGhoZm5odHh2Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0NzE0OTQyOSwiZXhwIjoyMDYyNzI1NDI5fQ.5hfLHnnwo-_2oS2V8-y7drqjYrojiDmL-AXhrO_HHvg';
  
  // å…¨å±€å¯¹è±¡åˆå§‹åŒ–
  window.supabase = supabase.createClient(SUPABASE_URL, SERVICE_KEY);
  window.App = {
    currentStep: 0,
    selections: {},
    multiSelections: {},
    customInputs: {},
    themes: [],
    password: 'admin123',
    editingTheme: null
  };

  // UIæ–¹æ³•å…¨å±€æš´éœ²
  window.UI = {
    togglePanel: function(panelId) {
      ['frontend', 'loginPanel', 'adminPanel'].forEach(id => 
        document.getElementById(id).classList.toggle('hidden', id !== panelId));
    },
    
    prevStep: function() {
      if (App.currentStep > 0) {
        App.currentStep--;
        this.updateProgress();
        this.renderThemeNav();
        this.renderCurrentStep();
      }
    },
    
    nextStep: function() {
      if (App.currentStep < App.themes.length - 1) {
        App.currentStep++;
        this.updateProgress();
        this.renderThemeNav();
        this.renderCurrentStep();
      } else {
        this.generateResult();
      }
    },
    
    generateResult: function() {
      const filtered = App.themes.filter((t, i) => {
        // æ£€æŸ¥æ˜¯å¦æœ‰é€‰æ‹©ï¼ˆå•é€‰ã€å¤šé€‰æˆ–è‡ªå®šä¹‰è¾“å…¥ï¼‰
        return App.selections[i] || 
               (App.multiSelections[i] && App.multiSelections[i].length > 0) ||
               (t.is_text_input && App.customInputs[i]);
      });
      
      if (filtered.length === 0) return this.showNotification('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹é¸é …ï¼', 'error');
      
      const result = filtered.map((t, i) => {
        let value = '';
        const theme = App.themes[i];
        
        if (theme.is_text_input) {
          // çº¯æ–‡å­—è¾“å…¥æ¨¡å¼
          value = App.customInputs[i] || '';
        } else if (theme.allowMultiSelect) {
          // å¤šé€‰æ¨¡å¼
          value = App.multiSelections[i]?.join(', ') || '';
        } else {
          // å•é€‰æ¨¡å¼
          value = App.selections[i] || '';
        }
        
        return `${t.name}: ${value}`;
      }).join('\n');
      
      document.getElementById('result').innerHTML = `
        <pre>${result}</pre>
        <div class="result-actions">
          <button onclick="UI.copyResult()">è¤‡è£½æç¤ºè©</button>
          <button onclick="UI.reset()">é‡æ–°é–‹å§‹</button>
        </div>
      `;
    },
    
    copyResult: function() {
      const text = document.querySelector('#result pre').textContent;
      navigator.clipboard.writeText(text).then(() => {
        this.showNotification('æç¤ºè©å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼', 'success', 2000);
      });
    },
    
    reset: function() {
      App.currentStep = 0;
      App.selections = {};
      App.multiSelections = {};
      App.customInputs = {};
      this.updateProgress();
      this.renderThemeNav();
      this.renderCurrentStep();
      document.getElementById('result').innerHTML = '';
    },
    
    handleInput: function(e) {
      App.customInputs[App.currentStep] = e.target.value;
    },
    
    updateProgress: function() {
      const progress = ((App.currentStep + 1) / App.themes.length) * 100;
      document.getElementById('progressBar').style.width = `${progress}%`;
      document.getElementById('currentStep').textContent = App.currentStep + 1;
      document.getElementById('totalSteps').textContent = App.themes.length;
    },
    
    renderThemeNav: function() {
      const nav = document.getElementById('themeNav');
      nav.innerHTML = App.themes.map((t, i) => `
        <div class="theme-nav-item ${i === App.currentStep ? 'active' : ''}" 
             onclick="UI.jumpToStep(${i})">${t.name}</div>
      `).join('');
    },
    
    jumpToStep: function(step) {
      App.currentStep = step;
      this.updateProgress();
      this.renderThemeNav();
      this.renderCurrentStep();
    },
    
    renderCurrentStep: function() {
      const container = document.getElementById('steps');
      const theme = App.themes[App.currentStep];
      const stepIndex = App.currentStep;
      
      if (!theme) {
        container.innerHTML = '<div class="step">æš«ç„¡å¯ç”¨ä¸»é¡Œ</div>';
        return;
      }

      let optionsHTML = '';
      
      if (theme.is_text_input) {
        // çº¯æ–‡å­—è¾“å…¥æ¨¡å¼ - å¿½ç•¥å¤šé€‰å’Œè‡ªå®šä¹‰
        optionsHTML = `
          <div class="text-input-mode">
            <input type="text" class="text-input" 
                   value="${App.customInputs[stepIndex] || ''}"
                   oninput="UI.handleInput(event)"
                   placeholder="è«‹è¼¸å…¥${theme.name}">
          </div>
        `;
      } else if (theme.allowMultiSelect) {
        // å¤šé€‰æ¨¡å¼
        const selectedOptions = App.multiSelections[stepIndex] || [];
        
        optionsHTML = `
          <div class="multi-select-options">
            ${theme.options.map(opt => `
              <div class="option ${selectedOptions.includes(opt) ? 'selected' : ''}" 
                   data-value="${opt}"
                   onclick="UI.toggleMultiOption('${opt.replace(/'/g, "\\'")}')">${opt}</div>
            `).join('')}
          </div>
        `;
        
        // å¦‚æœå…è®¸è‡ªå®šä¹‰è¾“å…¥ï¼Œæ·»åŠ è‡ªå®šä¹‰è¾“å…¥æ¡†
        if (theme.allow_custom) {
          optionsHTML += `
            <div class="custom-input">
              <input type="text" 
                     placeholder="è‡ªå®šç¾©è¼¸å…¥ (é¸é …å°‡ä»¥é€—è™Ÿåˆ†éš”)"
                     value="${selectedOptions.join(', ') || ''}"
                     oninput="UI.handleMultiCustomInput(event)">
            </div>
          `;
        }
        
        // æ˜¾ç¤ºå·²é€‰æ ‡ç­¾
        if (selectedOptions.length > 0) {
          optionsHTML += `
            <div class="selected-options">
              <h4>å·²é¸é¸é …</h4>
              <div class="selected-tags">
                ${selectedOptions.map(opt => `
                  <div class="tag">
                    ${opt}
                    <span class="tag-remove" onclick="UI.removeMultiOption('${opt.replace(/'/g, "\\'")}')">Ã—</span>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        }
      } else {
        // å•é€‰æ¨¡å¼
        optionsHTML = theme.options.map(opt => `
          <div class="option ${App.selections[stepIndex] === opt ? 'selected' : ''}" 
               onclick="UI.selectOption('${opt.replace(/'/g, "\\'")}')">${opt}</div>
        `).join('');
        
        // å¦‚æœå…è®¸è‡ªå®šä¹‰è¾“å…¥ï¼Œæ·»åŠ è‡ªå®šä¹‰è¾“å…¥æ¡†
        if (theme.allow_custom) {
          optionsHTML += `
            <div class="custom-input">
              <input type="text" 
                     placeholder="è‡ªå®šç¾©è¼¸å…¥"
                     value="${App.selections[stepIndex] || ''}"
                     oninput="UI.handleCustomInput(event)">
            </div>
          `;
        }
      }

      container.innerHTML = `
        <div class="step">
          <h3>${theme.name}</h3>
          <div class="options">
            ${optionsHTML}
          </div>
        </div>
      `;
    },
    
    toggleMultiOption: function(option) {
      const stepIndex = App.currentStep;
      if (!App.multiSelections[stepIndex]) {
        App.multiSelections[stepIndex] = [];
      }
      
      const index = App.multiSelections[stepIndex].indexOf(option);
      if (index >= 0) {
        // å·²é€‰æ‹©ï¼Œç§»é™¤
        App.multiSelections[stepIndex].splice(index, 1);
      } else {
        // æœªé€‰æ‹©ï¼Œæ·»åŠ 
        App.multiSelections[stepIndex].push(option);
      }
      
      this.renderCurrentStep();
    },
    
    removeMultiOption: function(option) {
      const stepIndex = App.currentStep;
      if (App.multiSelections[stepIndex]) {
        const index = App.multiSelections[stepIndex].indexOf(option);
        if (index >= 0) {
          App.multiSelections[stepIndex].splice(index, 1);
          this.renderCurrentStep();
        }
      }
    },
    
    handleMultiCustomInput: function(e) {
      const value = e.target.value;
      App.multiSelections[App.currentStep] = value.split(',').map(v => v.trim()).filter(v => v);
      this.renderCurrentStep();
    },
    
    handleCustomInput: function(e) {
      App.selections[App.currentStep] = e.target.value;
    },
    
    selectOption: function(option) {
      App.selections[App.currentStep] = option;
      this.renderCurrentStep();
    },
    
    showNotification: function(message, type, duration = 3000) {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = message;
      
      const container = type === 'error' ? document.body : document.getElementById('result');
      container.appendChild(notification);
      
      setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
      }, duration);
    },
    
    togglePassword: function(inputId) {
      const input = document.getElementById(inputId);
      if (input.type === 'password') {
        input.type = 'text';
      } else {
        input.type = 'password';
      }
    }
  };

  // æ ¸å¿ƒåŠŸèƒ½
  const Core = {
    sortableInstance: null,
    
    async init() {
      await this.loadData();
      this.initSortable();
      this.bindEvents();
      UI.renderThemeNav();
      UI.renderCurrentStep();
      UI.updateProgress();
      document.getElementById('frontend').classList.remove('hidden');
    },

    async loadData() {
      await Promise.all([
        this.loadThemes(),
        this.loadPassword()
      ]);
    },

    async loadThemes() {
      try {
        const { data, error } = await window.supabase
          .from('themes')
          .select('*')
          .order('sort_order', { ascending: true });
        
        if (error) {
          throw error;
        }
        
        App.themes = data || [];
      } catch (error) {
        console.error('åŠ è½½ä¸»é¢˜å¤±è´¥:', error);
        // ä½¿ç”¨é»˜è®¤ä¸»é¢˜ä½œä¸ºåå¤‡
        App.themes = [
          {
            id: 1,
            name: 'è‰ºæœ¯é£æ ¼',
            options: ['å†™å®ä¸»ä¹‰', 'å°è±¡æ´¾', 'æŠ½è±¡è‰ºæœ¯', 'è¶…ç°å®ä¸»ä¹‰', 'å¡é€šé£æ ¼'],
            allow_custom: true,
            is_text_input: false,
            allowMultiSelect: false,
            sort_order: 0
          },
          {
            id: 2,
            name: 'ä¸»é¢˜å†…å®¹',
            options: ['è‡ªç„¶é£æ™¯', 'åŸå¸‚é£å…‰', 'äººç‰©è‚–åƒ', 'ç§‘å¹»åœºæ™¯', 'åŠ¨ç‰©ä¸–ç•Œ'],
            allow_custom: true,
            is_text_input: false,
            allowMultiSelect: true,
            sort_order: 1
          }
        ];
      }
    },

    async loadPassword() {
      try {
        const { data } = await window.supabase
          .from('passwords')
          .select('password')
          .single();
        if (data) App.password = data.password;
      } catch (error) {
        console.error('åŠ è½½å¯†ç å¤±è´¥:', error);
        App.password = 'admin123';
      }
    },

    async updateThemeOrder(ids) {
      const updates = ids.map((id, index) => ({
        id: parseInt(id),
        sort_order: index
      }));

      // æ‰¹é‡æ›´æ–°æ’åºå€¼
      for (const update of updates) {
        const { error } = await window.supabase
          .from('themes')
          .update({ sort_order: update.sort_order })
          .eq('id', update.id);
        
        if (error) {
          console.error('æ›´æ–°æ’åºå¤±è´¥:', error);
          return false;
        }
      }
      
      return true;
    },

    initSortable() {
      const themeList = document.getElementById('themeList');
      if (!themeList) return;
      
      // é”€æ¯ç°æœ‰å®ä¾‹
      if (this.sortableInstance) {
        this.sortableInstance.destroy();
      }
      
      this.sortableInstance = new Sortable(themeList, {
        animation: 150,
        ghostClass: 'sortable-ghost',
        onUpdate: async (evt) => {
          const ids = Array.from(evt.from.children)
            .map(el => el.dataset.id)
            .filter(id => id !== undefined);
          
          // æ›´æ–°æ’åº
          const success = await this.updateThemeOrder(ids);
          if (success) {
            // é‡æ–°åŠ è½½ä¸»é¢˜
            await this.loadThemes();
            // åˆ·æ–°UI
            UI.renderThemeNav();
            Admin.loadThemes();
          }
        }
      });
    },

    async handleSaveTheme() {
      const nameInput = document.getElementById('newThemeName');
      const optionsInput = document.getElementById('newThemeOptions');
      
      const newTheme = {
        name: nameInput.value.trim(),
        options: optionsInput.value
          .split('\n')
          .map(o => o.trim())
          .filter(o => o),
        allow_custom: document.getElementById('allowCustom').checked,
        is_text_input: document.getElementById('isTextInput').checked,
        allowMultiSelect: document.getElementById('allowMultiSelect').checked,
        sort_order: App.themes.length
      };

      if (!newTheme.name) {
        UI.showNotification('è«‹è¼¸å…¥ä¸»é¡Œåç¨±ï¼', 'error');
        return;
      }
      
      if (!newTheme.is_text_input && newTheme.options.length === 0) {
        UI.showNotification('è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹é¸é …ï¼', 'error');
        return;
      }
      
      try {
        if (App.editingTheme) {
          // æ›´æ–°ç°æœ‰ä¸»é¢˜
          const { error } = await window.supabase
            .from('themes')
            .update(newTheme)
            .eq('id', App.editingTheme);
          
          if (error) throw error;
        } else {
          // æ·»åŠ æ–°ä¸»é¢˜
          const { error } = await window.supabase
            .from('themes')
            .insert(newTheme);
            
          if (error) throw error;
        }
        
        // é‡æ–°åŠ è½½ä¸»é¢˜å¹¶åˆ·æ–°UI
        await this.loadThemes();
        Admin.loadThemes();
        this.clearThemeForm();
        UI.showNotification('ä¸»é¡Œä¿å­˜æˆåŠŸï¼', 'success');
      } catch (error) {
        console.error('ä¿å­˜ä¸»é¢˜å¤±è´¥:', error);
        UI.showNotification(`ä¿å­˜å¤±æ•—: ${error.message}`, 'error');
      }
    },

    async handleChangePassword() {
      const oldPass = document.getElementById('oldPassword').value;
      const newPass = document.getElementById('newPassword').value;
      const confirmPass = document.getElementById('confirmPassword').value;

      if (newPass !== confirmPass) {
        UI.showNotification('æ–°å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ä¸ä¸€è‡´ï¼', 'error');
        return;
      }
      
      if (oldPass !== App.password) {
        UI.showNotification('èˆŠå¯†ç¢¼éŒ¯èª¤ï¼', 'error');
        return;
      }

      try {
        const { error } = await window.supabase
          .from('passwords')
          .upsert({ id: 1, password: newPass });
        
        if (error) throw error;
        
        App.password = newPass;
        this.clearPasswordForm();
        UI.showNotification('å¯†ç¢¼ä¿®æ”¹æˆåŠŸï¼', 'success');
      } catch (error) {
        console.error('ä¿®æ”¹å¯†ç å¤±è´¥:', error);
        UI.showNotification(`å¯†ç¢¼ä¿®æ”¹å¤±æ•—: ${error.message}`, 'error');
      }
    },

    bindEvents() {
      // å‰å°äº‹ä»¶
      document.getElementById('prevBtn').addEventListener('click', () => UI.prevStep());
      document.getElementById('nextBtn').addEventListener('click', () => UI.nextStep());
      document.getElementById('generateBtn').addEventListener('click', () => UI.generateResult());
      document.getElementById('adminEntry').addEventListener('click', () => UI.togglePanel('loginPanel'));
      
      // åå°äº‹ä»¶
      document.getElementById('backToFrontBtn').addEventListener('click', () => UI.togglePanel('frontend'));
      document.getElementById('loginBtn').addEventListener('click', () => this.handleLogin());
      document.getElementById('saveThemeBtn').addEventListener('click', () => this.handleSaveTheme());
      document.getElementById('changePasswordBtn').addEventListener('click', () => this.handleChangePassword());
      document.getElementById('cancelBtn').addEventListener('click', () => UI.togglePanel('frontend'));
      
      // å¯†ç æ˜¾ç¤º/éšè—
      document.getElementById('passwordToggle').addEventListener('click', () => UI.togglePassword('password'));
      document.getElementById('oldPasswordToggle').addEventListener('click', () => UI.togglePassword('oldPassword'));
      document.getElementById('newPasswordToggle').addEventListener('click', () => UI.togglePassword('newPassword'));
      document.getElementById('confirmPasswordToggle').addEventListener('click', () => UI.togglePassword('confirmPassword'));
    },

    async handleLogin() {
      const inputPass = document.getElementById('password').value;
      if (inputPass === App.password) {
        UI.togglePanel('adminPanel');
        await Admin.loadThemes();
      } else {
        UI.showNotification('å¯†ç¢¼éŒ¯èª¤ï¼', 'error');
      }
    },

    clearThemeForm() {
      document.getElementById('newThemeName').value = '';
      document.getElementById('newThemeOptions').value = '';
      document.getElementById('allowCustom').checked = false;
      document.getElementById('isTextInput').checked = false;
      document.getElementById('allowMultiSelect').checked = false;
      App.editingTheme = null;
    },

    clearPasswordForm() {
      document.getElementById('oldPassword').value = '';
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmPassword').value = '';
    }
  };

  // åå°ç®¡ç†æ¨¡å—
  window.Admin = {
    async loadThemes() {
      const container = document.getElementById('themeList');
      if (!container) return;
      
      container.innerHTML = App.themes.map(t => `
        <div class="theme-block" data-id="${t.id}">
          <h4>${t.name}</h4>
          <p>é¸é …ï¼š${t.options?.join(', ') || 'ç„¡'}</p>
          <p>è‡ªå®šç¾©ï¼š${t.allow_custom ? 'å…è¨±' : 'ä¸å…è¨±'}</p>
          <p>å¤šé¸ï¼š${t.allowMultiSelect ? 'å…è¨±' : 'ä¸å…è¨±'}</p>
          <p>æ¨¡å¼ï¼š${t.is_text_input ? 'æ–‡å­—è¼¸å…¥' : 'é¸é …é¸æ“‡'}</p>
          <p>æ’åºï¼š${t.sort_order}</p>
          <div class="admin-controls">
            <button onclick="Admin.editTheme(${t.id})">ç·¨è¼¯</button>
            <button class="delete-btn" onclick="Admin.deleteTheme(${t.id})">åˆªé™¤</button>
          </div>
        </div>
      `).join('');
      
      // é‡æ–°åˆå§‹åŒ–æ‹–æ”¾åŠŸèƒ½
      Core.initSortable();
    },

    async deleteTheme(id) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹ä¸»é¡Œå—ï¼Ÿ')) return;
      
      try {
        // åˆ é™¤ä¸»é¢˜
        const { error } = await window.supabase.from('themes').delete().eq('id', id);
        if (error) throw error;
        
        // é‡æ–°åŠ è½½ä¸»é¢˜
        await Core.loadThemes();
        
        // åˆ·æ–°ä¸»é¢˜åˆ—è¡¨
        this.loadThemes();
        
        // åˆ·æ–°å‰å°
        UI.renderThemeNav();
        UI.renderCurrentStep();
        UI.updateProgress();
        
        UI.showNotification('ä¸»é¡Œå·²åˆªé™¤ï¼', 'success');
      } catch (error) {
        console.error('åˆ é™¤ä¸»é¢˜å¤±è´¥:', error);
        UI.showNotification(`åˆªé™¤å¤±æ•—: ${error.message}`, 'error');
      }
    },

    async editTheme(id) {
      const theme = App.themes.find(t => t.id === id);
      if (!theme) return;
      
      document.getElementById('newThemeName').value = theme.name;
      document.getElementById('newThemeOptions').value = theme.options.join('\n');
      document.getElementById('allowCustom').checked = theme.allow_custom;
      document.getElementById('isTextInput').checked = theme.is_text_input;
      document.getElementById('allowMultiSelect').checked = theme.allowMultiSelect || false;
      App.editingTheme = id;
      
      // æ»šåŠ¨åˆ°è¡¨å•
      document.getElementById('newThemeName').scrollIntoView({ behavior: 'smooth' });
    }
  };

  // å•Ÿå‹•æ‡‰ç”¨
  document.addEventListener('DOMContentLoaded', () => Core.init());
})();
</script>
</body>
</html>
